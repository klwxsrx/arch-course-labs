# Пользовательские сценарии

## Как менеджер магазина я могу ...

* добавить или изменить описание и цену товара на витрине
* увидеть товар с описанием и ценой на витрине
* узнать количество товара на складе
* изменить количество товара на складе
* узнать состояние платежа
* узнать состояние доставки

## Как неавторизованный пользователь я могу ...

* увидеть список товаров с ценой и описанием на витрине
* зарегистрироваться в магазине
* войти в свою учетную запись в магазине

## Как авторизованный пользователь я могу ...

* выполнить выход из учетной записи
* увидеть список товаров с ценой и описанием на витрине
* увидеть товар в своей корзине
* положить/убрать/изменить количество товара в корзине
* купить товар в корзине оформив заказ
* могу узнать состояние заказа

# Общая схема сервисов

![docs/services.puml](http://www.plantuml.com/plantuml/proxy?fmt=svg&src=https://raw.githubusercontent.com/klwxsrx/arch-course-labs/master/08-decomposition/docs/services.puml)

Сплошными линиями обозначено синхронное REST-взаимодействие, пунктирными асинхронное общение на базе `Apache Pulsar`.

## Auth
`Auth` отвечает за аутентификацию пользователей. Регистрирует и хранит пары логин/пароль, при успешной логинации создаёт
пользовательские сессии и передаёт в Cookie браузера. Хранит эти сессии у себя и сопоставляет пользователя
по `sessionID` из запроса.

Сущности сервиса `User`, `Session`.

## Catalog
`Catalog` хранит описание и актуальную цену продаваемого товара, служит для отображения товаров доступных на витрине
магазина.

Сущность сервиса - `Product`.

## Cart

`Cart` - корзина товаров, здесь хранится список и количество товаров, которые пользователь собирается приобрести.

Сущность сервиса `Cart`, содержит идентификатор пользователя и коллекцию пар `ProductID: Quanity`.

В момент создания заказа сервис `Cart` идет в `Catalog`, чтобы получить актуальные цены товаров и сформировать запрос на создание заказа в сервис `Order`.

## Order

Сервис заказов, является оркестратором процесса выполнения заказа (схему процесса [см. здесь](https://github.com/klwxsrx/arch-course-labs/tree/master/09-saga)), его модель:
```go
const (
	OrderStatusCreated OrderStatus = iota
	OrderStatusPaymentAuthorized
	OrderStatusItemsReserved
	OrderStatusDeliveryScheduled
	OrderStatusSentToDelivery
	OrderStatusDelivered
	OrderStatusCancelled
)

type Order struct {
    ID          uuid.UUID
    UserID      uuid.UUID
    AddressID   uuid.UUID
    Items       []OrderItem
    Status      OrderStatus
    TotalAmount int // Полная стоимость заказа
}

type OrderItem struct {
	ID        uuid.UUID
	ItemPrice int
	Quantity  int
}
```

## Payment
Сервис платежей, хранит платежные данные пользователей, умеет работать с платежными системами. Служит для оплаты заказов создаваемых пользователями, его модель:
```go
const (
	PaymentStatusAuthorized PaymentStatus = iota
	PaymentStatusCancelled
	PaymentStatusCompleted
	PaymentStatusRejected
)

type Payment struct {
	OrderID     uuid.UUID
	TotalAmount int
	Status      PaymentStatus
}
```

## Warehouse
Склад товаров, хранит актуальные остатки товара и лог прихода/ухода товара. Может резервировать товар на складе для заказа.

## Delivery
Через него осуществляется планирование доставки и непосредственно доставка, включающая в себя взаимодействие с курьерами, ослеживание отправлений и т.п.